<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Label Quick Quote - Substrates (v001, Cerm API)</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --card: #151821;
      --muted: #8892a6;
      --text: #e6edf3;
      --accent: #3b82f6;
      --ok: #10b981;
      --bad: #ef4444;
      --border: #273041;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--text);
      display: flex; flex-direction: column; gap: 16px; padding: 16px;
    }
    h1 { font-size: 1.25rem; margin: 0; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: end; }
    label { display: inline-block; font-size: .85rem; color: var(--muted); margin-bottom: 4px; }
    input[type="text"], input[type="number"], input[type="search"] {
      background: #0e1220; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; min-width: 260px;
    }
    input[type="checkbox"] { transform: translateY(1px); }
    .btn { cursor: pointer; background: var(--accent); color: white; border: 0; border-radius: 8px; padding: 10px 14px; font-weight: 600; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .hint { color: var(--muted); font-size: .9rem; }
    .error { color: var(--bad); white-space: pre-wrap; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; font-size: .85rem; color: var(--muted); font-weight: 600; border-bottom: 1px solid var(--border); padding: 8px; }
    tbody td { border-bottom: 1px solid var(--border); padding: 8px; vertical-align: top; }
    code { background: #0e1220; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header class="card">
    <h1>Substrates â€“ Cerm API</h1>
    <div class="hint">This demo calls <code>GET /calculation/substrates</code> and renders a simple table. Replace the base URL and auth. Supports: None, Bearer token, or API Key (header/query). Be aware of CORS if calling a remote API from a local file.</div>
  </header>

  <section class="card">
    <div class="row" style="gap:16px">
      <div>
        <label for="baseUrl">Base URL (no trailing slash)</label><br/>
        <input id="baseUrl" type="text" placeholder="https://YOUR-CERM-BASE-URL" value="https://YOUR-CERM-BASE-URL" />
      </div>
      <div>
        <label for="authType">Auth</label><br/>
        <select id="authType">
          <option value="none">None</option>
          <option value="bearer" selected>Bearer token</option>
          <option value="apiKey">API Key</option>
        </select>
      </div>
      <div id="authBearer">
        <label for="token">Bearer token</label><br/>
        <input id="token" type="text" placeholder="eyJhbGciOi..." />
      </div>
      <div id="authApiKey" class="hidden">
        <label>API Key</label><br/>
        <div class="row" style="gap:8px">
          <div>
            <label for="apiKeyLocation">Location</label><br/>
            <select id="apiKeyLocation">
              <option value="header" selected>Header</option>
              <option value="query">Query</option>
            </select>
          </div>
          <div>
            <label for="apiKeyName">Name</label><br/>
            <input id="apiKeyName" type="text" placeholder="X-API-Key (or Authorization) / api_key" value="X-API-Key" />
          </div>
          <div>
            <label for="apiKeyValue">Value</label><br/>
            <input id="apiKeyValue" type="text" placeholder="your-api-key-value" />
          </div>
        </div>
      </div>
    </div>
    <div class="row" style="gap:16px; margin-top: 10px;">
      <div>
        <label for="filter">Filter (optional)</label><br/>
        <input id="filter" type="search" class="mono" placeholder="AllowQuickQuote eq true and AllowRFQ eq true" />
      </div>
      <div>
        <label for="orderBy">OrderBy (optional)</label><br/>
        <input id="orderBy" type="text" class="mono" placeholder="Id asc" />
      </div>
      <div>
        <label for="offset">Offset</label><br/>
        <input id="offset" type="number" min="0" value="0" />
      </div>
      <div>
        <label for="limit">Limit</label><br/>
        <input id="limit" type="number" min="1" placeholder="50" />
      </div>
      <div>
        <label for="metaOnly">MetaOnly</label><br/>
        <input id="metaOnly" type="checkbox" />
      </div>
      <div>
        <button id="loadBtn" class="btn">Load substrates</button>
      </div>
    </div>
    <div class="hint" style="margin-top:8px">Filterable fields: <code>Id</code>, <code>WebSite</code>, <code>Blocked</code>, <code>AllowQuickQuote</code>, <code>AllowRFQ</code>. Response field uses <code>Website</code>.</div>
    <div id="status" class="hint" style="margin-top:8px"></div>
    <div id="error" class="error" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <table>
      <thead>
        <tr>
          <th style="width:180px;">Id</th>
          <th>Description (en)</th>
          <th style="width:24ch;">Website</th>
          <th style="width:12ch;">AllowQuickQuote</th>
          <th style="width:8ch;">AllowRFQ</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="5" class="hint">No data yet. Click "Load substrates".</td></tr>
      </tbody>
    </table>
  </section>

  <script>
    const $ = (id) => document.getElementById(id);

    function getDescription(descriptions, preferred = 'en') {
      if (!Array.isArray(descriptions) || descriptions.length === 0) return '';
      const match = descriptions.find(d => (d.ISOLanguageCode || '').toLowerCase().startsWith(preferred));
      return (match && match.Description) || descriptions[0].Description || '';
    }

    function setStatus(text) { $("status").textContent = text || ''; }
    function setError(text) { $("error").textContent = text || ''; }

    function renderTable(items) {
      const tbody = $("rows");
      tbody.innerHTML = '';
      if (!Array.isArray(items) || items.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5; td.className = 'hint';
        td.textContent = 'No rows.';
        tr.appendChild(td); tbody.appendChild(tr);
        return;
      }
      for (const it of items) {
        const tr = document.createElement('tr');
        const w = it.Website ?? it.WebSite ?? '';
        const cells = [
          it.Id ?? '',
          getDescription(it.Descriptions, 'en'),
          w,
          String(it.AllowQuickQuote ?? ''),
          String(it.AllowRFQ ?? '')
        ];
        for (const c of cells) {
          const td = document.createElement('td');
          td.textContent = c;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function updateAuthVisibility() {
      const type = $("authType").value;
      $("authBearer").classList.toggle('hidden', type !== 'bearer');
      $("authApiKey").classList.toggle('hidden', type !== 'apiKey');
    }

    function applyAuthToRequest(url, headers) {
      const type = $("authType").value;
      if (type === 'bearer') {
        const token = $("token").value.trim();
        if (token) headers['Authorization'] = 'Bearer ' + token;
      } else if (type === 'apiKey') {
        const loc = $("apiKeyLocation").value;
        const name = $("apiKeyName").value.trim();
        const value = $("apiKeyValue").value.trim();
        if (name && value) {
          if (loc === 'header') headers[name] = value;
          else if (loc === 'query') url.searchParams.set(name, value);
        }
      }
    }

    async function loadSubstrates() {
      setError('');
      const btn = $("loadBtn");
      btn.disabled = true; setStatus('Loading...');
      try {
        const base = $("baseUrl").value.trim().replace(/\/+$/, '');
        if (!base || base.includes('YOUR-CERM-BASE-URL')) {
          throw new Error('Please set a valid Base URL (e.g. https://cerm.example.com/hd/RESTServices).');
        }
        const url = new URL(base + '/calculation/substrates');
        const filter = $("filter").value.trim();
        const orderBy = $("orderBy").value.trim();
        const offset = $("offset").value.trim();
        const limit = $("limit").value.trim();
        const metaOnly = $("metaOnly").checked;

        if (filter) url.searchParams.set('Filter', filter);
        if (orderBy) url.searchParams.set('OrderBy', orderBy);
        if (offset) url.searchParams.set('Offset', offset);
        if (limit) url.searchParams.set('Limit', limit);
        if (metaOnly) url.searchParams.set('MetaOnly', 'true');

        const headers = { 'Accept': 'application/json' };
        applyAuthToRequest(url, headers);

        const res = await fetch(url.toString(), { method: 'GET', headers });
        const text = await res.text();
        let json;
        try { json = text ? JSON.parse(text) : {}; } catch (e) {
          throw new Error('Non-JSON response. Status ' + res.status + '\n' + text);
        }

        if (!res.ok) {
          // API may return error array on non-200
          const msg = Array.isArray(json)
            ? json.map(e => `${e.Name || ''}: ${e.ErrorString || e.Description || e.Value || ''}`).join('\n')
            : (json.ErrorString || json.Description || JSON.stringify(json, null, 2));
          throw new Error(msg || ('HTTP ' + res.status));
        }

        // Success shape: { Meta, Data: [] }
        if (Array.isArray(json)) {
          // Unexpected success array; treat as rows
          renderTable(json);
          setStatus(`Loaded ${json.length} rows (array).`);
          return;
        }
        const data = json.Data || [];
        renderTable(data);
        const meta = json.Meta || {};
        const count = Array.isArray(data) ? data.length : 0;
        const parts = [];
        if (typeof meta.TotalCount === 'number') parts.push(`total ${meta.TotalCount}`);
        if (typeof meta.Pages === 'number') parts.push(`${meta.Pages} page(s)`);
        setStatus(`Loaded ${count} row(s)` + (parts.length ? ` â€¢ ${parts.join(', ')}` : ''));
      } catch (err) {
        setError(String(err && err.message ? err.message : err));
        setStatus('');
      } finally {
        btn.disabled = false;
      }
    }

    $("loadBtn").addEventListener('click', loadSubstrates);
    $("authType").addEventListener('change', updateAuthVisibility);
    $("apiKeyLocation")?.addEventListener('change', () => {
      const loc = $("apiKeyLocation").value;
      const nameEl = $("apiKeyName");
      if (!nameEl.value || nameEl.value === 'X-API-Key' || nameEl.value === 'api_key') {
        nameEl.value = (loc === 'header') ? 'X-API-Key' : 'api_key';
      }
    });
    updateAuthVisibility();
  </script>
</body>
</html>
